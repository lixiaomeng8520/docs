Iptables
========

参考

* `linux平台下防火墙iptables原理(转)​ <http://www.cnblogs.com/ggjucheng/archive/2012/08/19/2646466.html>`_
* `25个iptables常用示例​ <https://www.cnblogs.com/bill1015/p/6847841.html>`_


数据包流向
----------

.. image:: attach/iptables-1.png

命令
----

filter表
^^^^^^^^

链：INPUT、FORWARD、OUTPUT

+----------------------------+--------------------------------------------------------------------+
| 描述                       | 命令                                                               |
+============================+====================================================================+
| 默认策略                   | ``iptables -P <INPUT|OUTPUT|FORWARD> <ACCEPT|DROP>``               |
+----------------------------+--------------------------------------------------------------------+
| 控制本机的流量             | ``iptables -A INPUT -s 192.168.1.100 -j DROP``                     |
+----------------------------+--------------------------------------------------------------------+
|                            | ``iptables -A INPUT -p tcp --dport 80 -j DROP``                    |
+----------------------------+--------------------------------------------------------------------+
|                            | ``iptables -A INPUT -s 192.168.1.0/24 -p tcp --dport 22 -j DROP``  |
+----------------------------+--------------------------------------------------------------------+
|                            | ``iptables -A INPUT -i eth0 -j ACCEPT``                            |
+----------------------------+--------------------------------------------------------------------+
|                            | ``iptables -A INPUT -m state --state ESTABLISHED -j ACCEPT``       |
+----------------------------+--------------------------------------------------------------------+
| 控制转发的流量             | ``iptables -A FORWARD -s 192.168.1.0/24 -d 10.1.1.0/24 -j DROP``   |
+----------------------------+--------------------------------------------------------------------+

nat表
^^^^^

链：PREROUTING、OUTPUT、POSTROUTING

* SNAT 源地址转换，用于伪装内部地址。
* DNAT 目标地址换砖，通常用于跳转。

+----------------------------+--------------------------------------------------------------------------------------+
| 描述                       | 命令                                                                                 |
+============================+======================================================================================+
| 进入本机之前跳转           | ``iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-dest 192.168.1.10``   |
+----------------------------+--------------------------------------------------------------------------------------+
| 出本机之前跳转             | ``iptables -t nat -A OUTPUT -p tcp --dport -j DNAT --to-dest 192.168.1.100:8080``    |
+----------------------------+--------------------------------------------------------------------------------------+
| 一般意义的NAT              | ``iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE``                             |
+----------------------------+--------------------------------------------------------------------------------------+
| 隐藏源地址                 | ``iptables -t nat -A POSTROUTING -j SNAT --to-source 1.2.3.4``                       |
+----------------------------+--------------------------------------------------------------------------------------+

开启NAT步骤
-----------

设置内网主机默认网关

网关开启路由转发

.. code-block:: bash

    echo 1 > /proc/sys/net/ipv4/ip_forward

网关filter表forward链打开

.. code-block:: bash

    iptables -P FORWARD ACCEPT

网关设置nat规则

.. code-block:: bash

    iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

关于iptables-services
---------------------

使用iptables命令可以直接生效，但是如果系统重启，则不会自动加载上次的配置，所以要安装iptables-services，自动加载配置文件。

.. code-block:: bash

    yum install -y iptables-services

    systemctl enable iptables
    systemctl start iptables
