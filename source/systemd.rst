Systemd
=======

* `Systemd 入门教程：命令篇​ <http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html>`_
* `如何编写一个Systemd Service <https://segmentfault.com/a/1190000014740871>`_
  
主命令
  
+----------------------------+----------------------------------------------------------------+
| 命令                       | 描述                                                           |
+============================+================================================================+
| systemctl                  | 管理服务                                                       |
+----------------------------+----------------------------------------------------------------+
| systemd-analyze            | 启动耗时                                                       |
+----------------------------+----------------------------------------------------------------+
| hostnamectl                | 主机信息                                                       |
+----------------------------+----------------------------------------------------------------+
| localectl                  | 本地化设置                                                     |
+----------------------------+----------------------------------------------------------------+
| timedatectl                | 时间设置                                                       |
+----------------------------+----------------------------------------------------------------+
| loginctl                   | 登录用户                                                       |
+----------------------------+----------------------------------------------------------------+

systemd可以管理所有系统资源，不同的资源统称为unit。

+----------------------------+----------------------------------------------------------------+
| 类型                       | 描述                                                           |
+============================+================================================================+
| service                    | 系统服务                                                       |
+----------------------------+----------------------------------------------------------------+
| target                     | 多个unit构成一个组                                             |
+----------------------------+----------------------------------------------------------------+
| device                     | 硬件设备                                                       |
+----------------------------+----------------------------------------------------------------+
| mount                      | 文件系统挂载点                                                 |
+----------------------------+----------------------------------------------------------------+
| automount                  | 自动挂载点                                                     |
+----------------------------+----------------------------------------------------------------+
| path                       | 文件或路径                                                     |
+----------------------------+----------------------------------------------------------------+
| scope                      | 不是由systemd启动的外部进程                                    |
+----------------------------+----------------------------------------------------------------+
| slice                      | 进程组                                                         |
+----------------------------+----------------------------------------------------------------+
| snapshot                   | systemd 快照                                                   |
+----------------------------+----------------------------------------------------------------+
| socket                     | 进程间通信的socket                                             |
+----------------------------+----------------------------------------------------------------+
| swap                       | swap文件                                                       |
+----------------------------+----------------------------------------------------------------+
| timer                      | 定时器                                                         |
+----------------------------+----------------------------------------------------------------+

unit管理

+----------------------------+----------------------------------------------------------------+
| 描述                       | 命令                                                           |
+============================+================================================================+
| 正在运行的unit             | systemctl list-units                                           |
+----------------------------+----------------------------------------------------------------+
| 所有unit                   | systemctl --all list-units                                     |
+----------------------------+----------------------------------------------------------------+
| 类型为service的unit        | systemctl --type service list-units                            |
+----------------------------+----------------------------------------------------------------+
| 显示一个unit参数           | systemctl show nginx                                           |
+----------------------------+----------------------------------------------------------------+
| 状态                       | systemctl status nginx.service                                 |
+----------------------------+----------------------------------------------------------------+
| 启动                       | systemctl start nginx                                          |
+----------------------------+----------------------------------------------------------------+
| 停止                       | systemctl stop nginx                                           |
+----------------------------+----------------------------------------------------------------+
| 重启                       | systemctl restart nginx                                        |
+----------------------------+----------------------------------------------------------------+
| 重载配置文件               | systemctl reload nginx                                         |
+----------------------------+----------------------------------------------------------------+
| 杀死服务所有子进程         | systemctl kill nginx                                           |
+----------------------------+----------------------------------------------------------------+
| 开机启动                   | systemctl enable nginx                                         |
+----------------------------+----------------------------------------------------------------+
| 开机不启动                 | systemctl disable nginx                                        |
+----------------------------+----------------------------------------------------------------+

配置文件

/etc/systemd/system/ -> /usr/lib/systemd/system/

+----------------------------+----------------------------------------------------------------+
| 描述                       | 命令                                                           |
+============================+================================================================+
| 列出unit files             | systemctl list-unit-files --type=service                       |
+----------------------------+----------------------------------------------------------------+
| 列出单个unit files         | systemctl list-unit-files smb.service                          |
+----------------------------+----------------------------------------------------------------+

.. code-block:: bash

    [Unit]
    Description=Docs

    [Service]
    Type=forking
    PIDFile=/tmp/docs.pid
    ExecStartPre=/usr/bin/rm -rf /run/tmp/docs.pid
    ExecStartPre=/usr/bin/rm -rf /root/workspace/docs/_build
    ExecStart=/usr/bin/sphinx-autobuild -H 0.0.0.0 -p 8000 /root/workspace/docs /root/workspace/docs/_build/html

    [Install]
    WantedBy=multi-user.target